var define=window.define,tinyMCE=(window.M,window.tinyMCE);define("local_trustgrade/trustgrade",["jquery","core/ajax","core/notification","core/str","core/modal_factory"],($,Ajax,Notification,Str,ModalFactory)=>{var trustgrade={init:function(){this.bindEvents(),this.loadQuestionBank()},bindEvents:()=>{$(document).on("click","#check-instructions-btn",e=>{e.preventDefault(),trustgrade.checkInstructions()}),$(document).on("click","#generate-questions-btn",e=>{e.preventDefault(),trustgrade.generateQuestions()}),$(document).on("change","#id_trustgrade_questions_to_generate",e=>{e.preventDefault(),trustgrade.updateSingleQuizSetting("questions_to_generate",$(e.target).val())})},showErrorModal:(title,message)=>{ModalFactory.create({type:ModalFactory.types.ALERT,title:title,body:message}).then(modal=>modal.show())},showSuccessNotification:message=>{Notification.addNotification({message:message,type:"success"})},updateSingleQuizSetting:function(settingName,settingValue){var cmid=this.getCourseModuleId();cmid<=0||Ajax.call([{methodname:"local_trustgrade_update_quiz_setting",args:{cmid:cmid,setting_name:settingName,setting_value:settingValue}}])[0].done(response=>{response.success?Str.get_string("setting_updated_success","local_trustgrade",{setting:settingName.replace(/_/g," ")}).then(message=>{trustgrade.showSuccessNotification(message)}):Str.get_string("setting_update_error","local_trustgrade").then(title=>{trustgrade.showErrorModal(title,response.error||"An error occurred while updating the setting.")})}).fail(Notification.exception)},escapeHtml:value=>null==value?"":String(value).replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[s]||s)),renderRecommendation:recommendation=>{if("string"==typeof recommendation)return recommendation.replace(/\n/g,"<br>");if(!recommendation||"object"!=typeof recommendation)try{const txt=JSON.stringify(recommendation,null,2);return trustgrade.escapeHtml(txt).replace(/\n/g,"<br>")}catch(e){return""}const table=recommendation.table||{},rows=Array.isArray(table.rows)?table.rows:[],tableTitle=table.title||"Criteria Evaluation",evalText=recommendation.EvaluationText&&recommendation.EvaluationText.content?String(recommendation.EvaluationText.content):"",improved=recommendation.ImprovedAssignment&&recommendation.ImprovedAssignment.content?String(recommendation.ImprovedAssignment.content):"";let html="";return html+='<div class="tg-section tg-table-section" style="margin-bottom:16px;">',tableTitle&&(html+=`<h4 style="margin:0 0 8px 0;">${trustgrade.escapeHtml(tableTitle)}</h4>`),html+=`\n        <div class="table-responsive">\n          <table class="generaltable boxaligncenter" style="width:100%; border-collapse:collapse;">\n            <thead>\n              <tr>\n                <th style="text-align:left; border-bottom:1px solid #ddd; padding:8px;">${trustgrade.escapeHtml("Criterion")}</th>\n                <th style="text-align:left; border-bottom:1px solid #ddd; padding:8px;">${trustgrade.escapeHtml("Met")}</th>\n                <th style="text-align:left; border-bottom:1px solid #ddd; padding:8px;">${trustgrade.escapeHtml("Suggestions")}</th>\n              </tr>\n            </thead>\n            <tbody>\n      `,rows.length>0?rows.forEach(r=>{const c=trustgrade.escapeHtml(r.Criterion??""),m=trustgrade.escapeHtml(r.Met??r["Met (y/n)"]??""),s=trustgrade.escapeHtml(r.Suggestions??"");html+=`\n              <tr>\n                <td style="vertical-align:top; border-bottom:1px solid #eee; padding:8px;">${c}</td>\n                <td style="vertical-align:top; border-bottom:1px solid #eee; padding:8px;">${m}</td>\n                <td style="vertical-align:top; border-bottom:1px solid #eee; padding:8px;">${s}</td>\n              </tr>\n          `}):html+=`\n              <tr>\n                <td colspan="3" style="padding:8px; color:#666;">${trustgrade.escapeHtml("No criteria provided.")}</td>\n              </tr>\n        `,html+="\n            </tbody>\n          </table>\n        </div>\n      </div>\n      ",html+='<div class="tg-section tg-eval-text" style="margin-bottom:16px;">',html+=`<h4 style="margin:0 0 8px 0;">${trustgrade.escapeHtml("Evaluation")}</h4>`,html+=`<div>${trustgrade.escapeHtml(evalText).replace(/\n/g,"<br>")}</div>`,html+="</div>",html+='<div class="tg-section tg-improved" style="margin-bottom:8px;">',html+=`<h4 style="margin:0 0 8px 0;">${trustgrade.escapeHtml("Improved Assignment")}</h4>`,html+=`<div>${trustgrade.escapeHtml(improved).replace(/\n/g,"<br>")}</div>`,html+="</div>",html},checkInstructions:function(){var instructions=this.getInstructions();if(instructions&&0!==instructions.trim().length){$("#check-instructions-btn").prop("disabled",!0),$("#ai-loading").show(),$("#ai-recommendation-container").hide();var cmid=this.getCourseModuleId();Ajax.call([{methodname:"local_trustgrade_check_instructions",args:{cmid:cmid,instructions:instructions,intro_itemid:trustgrade.getIntroEditorItemId(),intro_attachments_itemid:trustgrade.getIntroAttachmentsItemId()}}])[0].done(response=>{if(response.success){var recommendationHtml="";try{var recObj="string"==typeof response.recommendation?JSON.parse(response.recommendation):response.recommendation;recommendationHtml=trustgrade.renderRecommendation(recObj)}catch(e){recommendationHtml=String(response.recommendation||"").replace(/\n/g,"<br>")}response.from_cache?Str.get_string("cache_hit","local_trustgrade").then(cacheMessage=>{recommendationHtml='<div class="alert alert-info mb-2"><i class="fa fa-clock-o"></i> <small>'+cacheMessage+" (Debug mode)</small></div>"+recommendationHtml,$("#ai-recommendation").html(recommendationHtml)}):$("#ai-recommendation").html(recommendationHtml),$("#ai-recommendation-container").show()}else Str.get_string("gateway_error","local_trustgrade").then(title=>{trustgrade.showErrorModal(title,response.error||"An error occurred.")})}).fail(Notification.exception).always(()=>{$("#check-instructions-btn").prop("disabled",!1),$("#ai-loading").hide()})}else Str.get_string("no_instructions_error","local_trustgrade").then(message=>{Str.get_string("input_validation_error","local_trustgrade").then(title=>{trustgrade.showErrorModal(title,message)})})},generateQuestions:function(){var instructions=this.getInstructions();if(instructions&&0!==instructions.trim().length){$("#generate-questions-btn").prop("disabled",!0),$("#ai-question-loading").show(),$("#ai-questions-container").hide();var cmid=this.getCourseModuleId();Ajax.call([{methodname:"local_trustgrade_generate_questions",args:{cmid:cmid,instructions:instructions,intro_itemid:trustgrade.getIntroEditorItemId(),intro_attachments_itemid:trustgrade.getIntroAttachmentsItemId()}}])[0].done(response=>{if(response.success){var questions="string"==typeof response.questions?JSON.parse(response.questions):response.questions;trustgrade.formatQuestionsDisplay(questions).then(questionsHtml=>{response.from_cache?Str.get_string("cache_hit","local_trustgrade").then(cacheMessage=>{questionsHtml='<div class="alert alert-info mb-2"><i class="fa fa-clock-o"></i> <small>'+cacheMessage+" (Debug mode)</small></div>"+questionsHtml,$("#ai-questions").html(questionsHtml)}):$("#ai-questions").html(questionsHtml),$("#ai-questions-container").show()}),response.message&&trustgrade.showSuccessNotification(response.message),trustgrade.loadQuestionBank()}else Str.get_string("gateway_error","local_trustgrade").then(title=>{trustgrade.showErrorModal(title,response.error||"An error occurred.")})}).fail(Notification.exception).always(()=>{$("#generate-questions-btn").prop("disabled",!1),$("#ai-question-loading").hide()})}else Str.get_string("no_instructions_questions_error","local_trustgrade").then(message=>{Str.get_string("input_validation_error","local_trustgrade").then(title=>{trustgrade.showErrorModal(title,message)})})},formatQuestionsDisplay:questions=>new Promise(resolve=>{Promise.all([Str.get_string("generated_questions","local_trustgrade"),Str.get_string("question","local_trustgrade"),Str.get_string("points","local_trustgrade"),Str.get_string("correct","local_trustgrade"),Str.get_string("explanation","local_trustgrade")]).then(strings=>{const[sGeneratedQuestions,sQuestion,sPoints,sCorrect,sExplanation]=strings;let html="<h4>"+sGeneratedQuestions+":</h4>";if(!Array.isArray(questions)||0===questions.length)return html+=`<div style="color:#666;">${trustgrade.escapeHtml("No questions generated.")}</div>`,void resolve(html);questions.forEach((q,index)=>{const qType=q&&q.type?String(q.type):"",qText=q&&q.text?String(q.text):"",points=q&&q.metadata&&("number"==typeof q.metadata.points||"string"==typeof q.metadata.points)?String(q.metadata.points):"",blooms=q&&q.metadata&&q.metadata.blooms_level?String(q.metadata.blooms_level):"";html+='<div class="question-item" style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">';let header=`${sQuestion} ${index+1}`;""!==points&&(header+=` (${trustgrade.escapeHtml(points)} ${sPoints})`),html+=`<h5>${trustgrade.escapeHtml(header)}</h5>`,qType&&(html+=`<p><strong>Type:</strong> ${trustgrade.escapeHtml(qType)}</p>`),html+=`<p><strong>${trustgrade.escapeHtml(sQuestion)}:</strong> ${trustgrade.escapeHtml(qText)}</p>`,blooms&&(html+=`<p><strong>${trustgrade.escapeHtml("Bloom's level")}:</strong> ${trustgrade.escapeHtml(blooms)}</p>`),Array.isArray(q.options)&&q.options.length>0&&(html+='<div><strong>Options:</strong></div><ul style="margin:6px 0 0 20px;">',q.options.forEach((opt,optIndex)=>{const label=String.fromCharCode(65+optIndex)+".",optText=opt&&opt.text?String(opt.text):"",isCorrect=!(!opt||!opt.is_correct),explanation=opt&&opt.explanation?String(opt.explanation):"",correctBadge=isCorrect?` <span class="badge badge-success" style="display:inline-block; padding:2px 6px; background:#16a34a; color:#fff; border-radius:4px; font-size:12px;">${trustgrade.escapeHtml(sCorrect)}</span>`:"";html+='<li style="margin:6px 0;">',html+=`<div>${trustgrade.escapeHtml(label)} ${trustgrade.escapeHtml(optText)}${correctBadge}</div>`,explanation&&(html+=`<div style="margin-left:20px; color:#555;"><em>${trustgrade.escapeHtml(sExplanation)}:</em> ${trustgrade.escapeHtml(explanation)}</div>`),html+="</li>"}),html+="</ul>"),html+="</div>"}),resolve(html)})}),getInstructions:()=>{for(var instructions="",instructionSelectors=["#id_introeditor_ifr","#id_intro",'textarea[name="intro"]'],i=0;i<instructionSelectors.length;i++){var $element=$(instructionSelectors[i]);if($element.length>0){if($element.is("iframe"))try{var iframeDoc=$element[0].contentDocument||$element[0].contentWindow.document;instructions=$("<div>").html(iframeDoc.body.innerHTML).text()}catch(e){void 0!==tinyMCE&&tinyMCE.get("id_introeditor")&&(instructions=tinyMCE.get("id_introeditor").getContent({format:"text"}))}else instructions=$element.val()||"";if(instructions&&instructions.trim().length>0)break}}return"string"==typeof instructions?instructions.trim():""},getCourseModuleId:()=>{var cmid=new URLSearchParams(window.location.search).get("update");return cmid||(cmid=$('input[name="coursemodule"]').val()||0),Number.parseInt(cmid)||0},getIntroEditorItemId:()=>{var $input=$('input[name="introeditor[itemid]"]'),val=$input.length?$input.val():"",n=Number.parseInt(val||"0",10);return isNaN(n)?0:n},getIntroAttachmentsItemId:()=>{for(var candidates=['input[name="introattachments"]','input[name="introattachments_filemanager"]','input[name="introattachments[itemid]"]'],i=0;i<candidates.length;i++){var $el=$(candidates[i]);if($el.length){var v=Number.parseInt($el.val()||"0",10);if(!isNaN(v)&&v>0)return v}}return 0},loadQuestionBank:function(){var cmid=this.getCourseModuleId();cmid<=0||($("#question-bank-loading").show(),Ajax.call([{methodname:"local_trustgrade_get_question_bank",args:{cmid:cmid}}])[0].done(response=>{if(response.success){var questions=JSON.parse(response.questions);questions&&questions.length>0?Str.get_string("question_bank_title","local_trustgrade").then(title=>{var questionBankHtml="<h4>"+title+"</h4>"+response.html;$("#question-bank-container").html(questionBankHtml),"undefined"!=typeof require&&require(["local_trustgrade/question_editor"],QuestionEditor=>{QuestionEditor.reinitialize(cmid)})}):$("#question-bank-container").html("")}else Notification.addNotification({message:response.error||"Failed to load question bank",type:"warning"})}).fail(Notification.exception).always(()=>{$("#question-bank-loading").hide()}))}};return trustgrade});

//# sourceMappingURL=trustgrade.min.js.map
